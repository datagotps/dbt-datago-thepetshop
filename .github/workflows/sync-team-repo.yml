name: Sync Selected Files to Team Repo

on:
  push:
    branches:
      - dev_anmar
    paths:
      - 'models/2_int/5_item/int_items.sql'
      - 'models/2_int/5_item/int_items_2.sql'
      - 'models/3_fct/fact_commercial.sql'
      - 'models/3_fct/dim_items.sql'
  workflow_dispatch:

jobs:
  sync-to-team-repo:
    runs-on: ubuntu-latest
    env:
      TEAM_REPO_TOKEN: ${{ secrets.TEAM_REPO_TOKEN }}
    
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config --global user.name 'DataGo Bot'
          git config --global user.email 'anmar@8020datago.ai'
      
      - name: Create sync directory structure
        run: |
          mkdir -p sync/models/2_int/5_item
          mkdir -p sync/models/3_fct
      
      - name: Copy selected files
        run: |
          cp models/2_int/5_item/int_items.sql sync/models/2_int/5_item/ || exit 1
          cp models/2_int/5_item/int_items_2.sql sync/models/2_int/5_item/ || exit 1
          cp models/3_fct/fact_commercial.sql sync/models/3_fct/ || exit 1
          cp models/3_fct/dim_items.sql sync/models/3_fct/ || exit 1
          echo "✓ All files copied successfully"
      
      - name: Verify secret is loaded
        run: |
          if [ -z "$TEAM_REPO_TOKEN" ]; then
            echo "❌ ERROR: TEAM_REPO_TOKEN is NOT set or is empty!"
            echo "Please check:"
            echo "1. Secret exists at: https://github.com/datagotps/dbt-datago-thepetshop/settings/secrets/actions"
            echo "2. Secret name is EXACTLY: TEAM_REPO_TOKEN (case-sensitive)"
            echo "3. Secret value is not empty"
            exit 1
          else
            echo "✓ TEAM_REPO_TOKEN is set (length: ${#TEAM_REPO_TOKEN} characters)"
          fi
      
      - name: Clone team repo
        run: |
          # Use x-access-token prefix for proper authentication
          git clone https://x-access-token:${TEAM_REPO_TOKEN}@github.com/datagotps/dbt-datago-thepetshop-team.git team-repo || exit 1
          echo "✓ Team repo cloned successfully"
      
      - name: Sync files to team repo
        run: |
          rsync -av --delete sync/ team-repo/ || exit 1
          cd team-repo
          
          # Configure remote URL with token for push
          git remote set-url origin https://x-access-token:${TEAM_REPO_TOKEN}@github.com/datagotps/dbt-datago-thepetshop-team.git
          
          git add .
          
          # Commit only if there are changes
          if ! git diff-index --quiet HEAD; then
            git commit -m "Sync from main repo: $(date '+%Y-%m-%d %H:%M:%S')" || exit 1
            # Push current branch to main branch on remote
            git push origin HEAD:main || exit 1
            echo "✓ Files synced and pushed successfully"
          else
            echo "No changes to commit - files are already up to date."
          fi
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf sync
          rm -rf team-repo
